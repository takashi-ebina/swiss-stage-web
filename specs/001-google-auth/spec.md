# 機能仕様: Google OAuth2 ログイン認証

**Feature Branch**: `001-google-auth`  
**作成日**: 2025-12-31  
**ステータス**: 下書き  
**入力**: ユーザーの説明: "ログイン（Google OAuth2認証）"

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - 大会運営者のログイン (優先度: P1)

大会運営者がGoogle アカウントを使用してシステムにログインし、トーナメント管理機能にアクセスできるようにする。

**なぜこの優先度か**: 
- MVP機能の基盤となる認証機構であり、すべての管理機能にアクセスするための前提条件
- パスワード管理の手間を省き、Googleの堅牢なセキュリティを活用できる
- 他のすべてのP1機能（トーナメント一覧、対戦表、ランキング等）はこの認証機能に依存する

**独立したテスト**: 
「Google ログインボタンをクリックしてGoogle認証画面に遷移し、認証成功後にダッシュボードにリダイレクトされる」一連のフローで完全にテストでき、ログイン状態の確認も可能。

**受け入れシナリオ**:

1. **前提** ログインしていない状態でアプリケーションにアクセス, **操作** 「Googleでログイン」ボタンをクリック, **結果** Google OAuth2認証画面（consent screen）にリダイレクトされる
2. **前提** Google認証画面が表示されている, **操作** 有効なGoogleアカウントで認証を許可, **結果** アプリケーションのダッシュボード画面にリダイレクトされ、ユーザー名（Googleアカウント名）がヘッダーに表示される
3. **前提** ログイン済み状態, **操作** ブラウザを閉じて再度アプリケーションにアクセス, **結果** セッションが有効な間（24時間以内）はログイン状態が維持され、ダッシュボードに直接アクセスできる
4. **前提** ログイン済み状態, **操作** 「ログアウト」ボタンをクリック, **結果** セッションが破棄され、ログイン画面にリダイレクトされる

---

### ユーザーストーリー 2 - 認証エラーハンドリング (優先度: P1)

Google認証が失敗した場合や、アクセスが拒否された場合に、ユーザーに分かりやすいエラーメッセージを表示する。

**なぜこの優先度か**: 
- 認証失敗時にユーザーが混乱しないよう、明確なフィードバックが必須
- システムの信頼性とユーザー体験の向上に直結する

**独立したテスト**: 
「Google認証で『キャンセル』または『拒否』を選択した場合、エラーメッセージが表示されてログイン画面に戻る」フローで独立してテスト可能。

**受け入れシナリオ**:

1. **前提** Google認証画面が表示されている, **操作** ユーザーが認証を拒否（キャンセルボタンをクリック）, **結果** ログイン画面に戻り、「認証がキャンセルされました」というメッセージが表示される
2. **前提** Google認証画面が表示されている, **操作** ネットワークエラーが発生, **結果** ログイン画面に戻り、「ネットワークエラーが発生しました。再度お試しください」というエラーメッセージが表示される
3. **前提** 無効なOAuth設定（Client IDが間違っている等）, **操作** ログイン試行, **結果** 「認証エラーが発生しました。管理者にお問い合わせください」というメッセージが表示され、エラー詳細がCloudWatch Logsに記録される

---

### エッジケース

- **初回ログイン時**: Googleアカウントでの初回ログイン時、ユーザー情報（メールアドレス、名前）をDynamoDBに自動登録する
- **セッションタイムアウト**: 24時間後にセッションが自動的に無効化され、再ログインが必要になる
- **同時ログイン**: 同一Googleアカウントで複数ブラウザ/デバイスから同時ログインしても問題なく動作する
- **OAuth2スコープ**: 必要最小限のスコープ（\`openid\`, \`email\`, \`profile\`）のみを要求し、余分な権限を求めない

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムはGoogle OAuth2プロトコルを使用してユーザーを認証しなければならない（MUST）
- **FR-002**: システムは認証成功後、JWTトークンを発行してセッション管理を行わなければならない（MUST）
- **FR-003**: システムはJWTトークンの有効期限を24時間に設定しなければならない（MUST）
- **FR-004**: システムは初回ログイン時、ユーザー情報（Google ID、メールアドレス、名前）をDynamoDBに保存しなければならない（MUST）
- **FR-005**: システムはログイン状態をローカルストレージまたはHTTP-only Cookieに保存しなければならない（MUST）
- **FR-006**: システムはログアウト時、JWTトークンを無効化し、クライアント側のセッション情報を削除しなければならない（MUST）
- **FR-007**: システムは認証エラー（ネットワークエラー、OAuth設定ミス、ユーザー拒否）を適切にハンドリングし、ユーザーフレンドリーなエラーメッセージを表示しなければならない（MUST）
- **FR-008**: システムは認証関連のエラーを構造化ログ（JSON形式）でCloudWatch Logsに記録しなければならない（MUST）
- **FR-009**: システムは未認証ユーザーが管理機能（トーナメント作成、参加者登録等）にアクセスしようとした場合、ログイン画面にリダイレクトしなければならない（MUST）
- **FR-010**: システムはGoogle OAuth2の必要最小限のスコープ（\`openid\`, \`email\`, \`profile\`）のみを要求しなければならない（MUST）

### 主要なエンティティ *(機能がデータを含む場合に記載)*

> **注意**: このプロジェクトではバックエンドにDDDを採用しています。
> エンティティは \`domain/model\` 層に配置し、ビジネスロジックを含めます。

- **User（ユーザー）**: 大会運営者を表すドメインエンティティ
  - 属性: \`userId\` (UUID), \`googleId\` (String), \`email\` (String), \`displayName\` (String), \`createdAt\` (Timestamp), \`lastLoginAt\` (Timestamp)
  - 不変条件: \`googleId\`と\`email\`は必須かつ一意、\`displayName\`は1文字以上100文字以下
  - ビジネスロジック: 最終ログイン日時の更新、ユーザー名の検証

- **AuthSession（認証セッション）**: 認証セッション情報を表す値オブジェクト
  - 属性: \`jwtToken\` (String), \`userId\` (UUID), \`expiresAt\` (Timestamp)
  - 不変条件: \`jwtToken\`は署名済み、\`expiresAt\`は発行時刻から24時間後
  - ビジネスロジック: トークンの有効性検証、有効期限チェック

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: 大会運営者は「Googleでログイン」ボタンクリックから認証完了までを30秒以内に完了できる
- **SC-002**: Google認証画面への遷移は3秒以内に完了する
- **SC-003**: 認証成功後のダッシュボードリダイレクトは2秒以内に完了する
- **SC-004**: 認証エラー発生時、90%以上のケースでユーザーに具体的なエラーメッセージが表示される
- **SC-005**: セッション管理により、24時間以内の再アクセス時に再ログインが不要（Cookie/LocalStorage有効時）
- **SC-006**: 同時ログイン数300ユーザーまで応答時間の劣化なく処理できる

### ビジネス成果

- **SC-007**: パスワード管理の手間が完全に排除され、パスワード忘れによるサポート問い合わせがゼロになる
- **SC-008**: Google認証の堅牢性により、不正ログイン試行がゼロになる

## 前提条件

- Google Cloud Consoleでプロジェクトを作成し、OAuth 2.0クライアントIDを取得済みであること
- OAuth同意画面（Consent Screen）を設定済みであること
- リダイレクトURIがGoogle Cloud Consoleに登録済みであること（例: \`https://your-domain.com/auth/google/callback\`）
- Spring Boot側でGoogle OAuth2ライブラリ（\`spring-boot-starter-oauth2-client\`）が依存関係に追加済みであること
- フロントエンド側でGoogle認証ボタンのUIが実装可能であること（Material-UI使用）

## 依存関係

### 外部サービス
- **Google OAuth2 API**: ユーザー認証プロバイダー
- **AWS DynamoDB**: ユーザー情報の永続化

### 内部依存
- なし（この機能はMVPの最初の実装であり、他機能への依存なし）

## スコープ外

- パスワードベース認証（将来的にも実装しない）
- 多要素認証（MFA）の追加要件（Google側のMFAは尊重）
- ソーシャルログイン（Facebook, Twitter等）の追加
- メールアドレス/パスワードでのユーザー登録機能
- ロール・権限管理（現時点では全ユーザーが大会運営者として扱われる）

## セキュリティ考慮事項

- **HTTPS必須**: OAuth2認証はHTTPS環境でのみ動作（本番環境）
- **CSRF保護**: Spring SecurityのCSRF保護を有効化
- **JWT署名**: JWTトークンはHS256アルゴリズムで署名し、秘密鍵は環境変数で管理
- **トークン漏洩対策**: JWTトークンはHTTP-only Cookieに保存し、JavaScriptからのアクセスを防ぐ
- **リダイレクトURI検証**: Google OAuth2のリダイレクトURIをホワイトリスト化
- **ログ記録**: 認証失敗・成功イベントをCloudWatch Logsに記録（監査用）

## パフォーマンス要件

- Google OAuth2認証画面への遷移: 3秒以内
- 認証コールバック処理（トークン発行）: 2秒以内
- JWT検証: 100ms以内
- 同時認証処理: 300ユーザーまで対応

## 非機能要件

- **可用性**: 大会運営中（2-3時間）は無停止稼働
- **可観測性**: 認証成功率・失敗率をCloudWatch Metricsで監視
- **エラーハンドリング**: すべてのOAuth2エラーを適切にキャッチし、ユーザーフレンドリーなメッセージに変換
- **国際化**: 現時点では日本語のみ対応（将来的に多言語対応の余地を残す）
