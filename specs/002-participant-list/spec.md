# 機能仕様: 参加者一覧管理（グループ別CSV入出力対応）

**Feature Branch**: `002-participant-list`  
**作成日**: 2026-01-03  
**ステータス**: 下書き  
**入力**: 参加者一覧（CSV入出力）の実装。グループタブで最大8グループを管理し、各グループで所属・名前・段級位を管理。グループ単位でのCSV入出力、段級位順ソート、奇数時のダミーユーザー追加機能を提供

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - グループ別参加者の手動登録と対戦表への反映 (優先度: P1)

大会主催者が、グループタブ（GROUP 1～GROUP 8）から対象グループを選択し、参加者の所属・名前・段級位を入力フォームから登録する。「参加者登録」ボタンを押下すると、そのグループ内で参加者が段級位順にソートされ、対戦表に反映される。グループ内の参加人数が奇数の場合は自動的にダミーユーザーが追加され、全員が試合可能な状態になる。

**なぜこの優先度か**: スイス方式トーナメントの運営には参加者情報の正確な登録が必須。グループ別管理により大規模大会（最大256名：8グループ×32名）にも対応可能。段級位順のソートは対戦組合せの基準となり、奇数時のダミーユーザー追加は試合進行の必須条件であるため、P1とする。

**独立したテスト**: グループタブを選択し、参加者入力フォームから登録ボタン押下までの一連の操作で完全にテストでき、対戦表に参加者が正しく表示されることを検証できる。

**受け入れシナリオ**:

1. **前提** GROUP 1タブが選択された状態で参加者一覧画面が表示されている, **操作** 所属「株式会社ABC」、名前「山田太郎」、段級位「3段」を入力して「参加者登録」を押下, **結果** GROUP 1の参加者一覧に1名表示され、対戦表に「山田太郎（3段）」が反映される
2. **前提** GROUP 1に2名（山田太郎/3段、鈴木次郎/5段）が登録済み, **操作** 所属「株式会社XYZ」、名前「佐藤三郎」、段級位「4段」を入力して「参加者登録」を押下, **結果** GROUP 1の参加者一覧が段級位の高い順（鈴木次郎/5段、佐藤三郎/4段、山田太郎/3段）にソートされて表示される
3. **前提** GROUP 1に3名が登録済み（奇数）, **操作** 「参加者登録」を押下, **結果** GROUP 1の参加者一覧に「ダミーユーザー（不戦勝）」が自動追加され、合計4名（偶数）になる
4. **前提** GROUP 1に4名が登録済み（偶数）, **操作** 「参加者登録」を押下, **結果** GROUP 1ではダミーユーザーは追加されず、4名のまま対戦表に反映される
5. **前提** GROUP 1に31名が登録済み, **操作** 所属「株式会社DEF」、名前「高橋五郎」、段級位「2段」を入力して「参加者登録」を押下, **結果** GROUP 1の参加者一覧に32名表示される（上限到達）
6. **前提** GROUP 1に32名が登録済み（上限）, **操作** 追加で参加者を登録しようとする, **結果** 「グループの参加人数上限は32名です」というエラーメッセージが表示され、参加者は登録されない
7. **前提** 参加者一覧画面が表示されている, **操作** 名前「田中四郎」のみ入力し段級位を空欄のまま「参加者登録」を押下, **結果** 「段級位は必須です」というエラーメッセージが表示され、参加者は登録されない
8. **前提** GROUP 1に10名、GROUP 2に5名が登録済み, **操作** GROUP 2タブを選択, **結果** GROUP 2の5名のみが表示される（GROUP 1の参加者は表示されない）

---

### ユーザーストーリー 2 - グループ単位でのCSVファイル一括取込 (優先度: P1)

大会主催者が、グループタブから対象グループを選択し、事前に準備したCSVファイル（所属、名前、段級位を含む）を「CSV取込」ボタンから読み込む。選択されたグループに複数の参加者が一括で登録される。取込後は手動登録と同様にそのグループ内で段級位順にソートされ、奇数の場合はダミーユーザーが追加される。

**なぜこの優先度か**: 16-256名規模の大会では手動入力は非現実的。グループ単位でのCSV一括取込により、大規模大会でも効率的に運営できるため、P1とする。

**独立したテスト**: グループタブを選択し、CSVファイルをアップロードして、選択したグループの参加者一覧に正しく反映されることを検証できる。

**受け入れシナリオ**:

1. **前提** GROUP 1タブが選択された状態で参加者一覧画面が表示されている, **操作** 所属・名前・段級位を含む正しいフォーマットのCSVファイル（10名分）を「CSV取込」ボタンから選択してアップロード, **結果** GROUP 1に10名の参加者が段級位順にソートされて表示され、対戦表に反映される
2. **前提** 参加者一覧画面が表示されている, **操作** 名前列が欠落しているCSVファイルをアップロード, **結果** 「名前列が必須です」というエラーメッセージが表示され、参加者は登録されない
3. **前提** 参加者一覧画面が表示されている, **操作** 段級位列に「abc段」など無効な値を含むCSVファイルをアップロード, **結果** 「段級位の形式が不正です（行X）」というエラーメッセージが表示され、参加者は登録されない
4. **前提** GROUP 1に既に5名が登録済み, **操作** GROUP 1タブでさらに10名分のCSVファイルをアップロード, **結果** GROUP 1の既存5名と新規10名の合計15名が段級位順にソートされて表示され、ダミーユーザーが1名追加される（合計16名）
5. **前提** GROUP 1に20名が登録済み, **操作** GROUP 1タブで15名分のCSVファイルをアップロード（合計35名になる）, **結果** 「グループの参加人数上限は32名です。現在20名登録済みのため、追加可能なのは12名までです」というエラーメッセージが表示され、参加者は登録されない
6. **前提** GROUP 1に10名、GROUP 2に5名が登録済み, **操作** GROUP 3タブを選択し、8名分のCSVファイルをアップロード, **結果** GROUP 3に8名が新規登録される（GROUP 1とGROUP 2のデータには影響なし）

---

### ユーザーストーリー 3 - グループ単位での参加者一覧CSV出力 (優先度: P2)

大会主催者が、グループタブから対象グループを選択し、「CSV出力」ボタンを押下することで、そのグループの参加者一覧をダウンロードする。Excel等で編集・管理できる形式で保存され、バックアップや他のシステムとのデータ連携が可能になる。

**なぜこの優先度か**: 必須機能ではないが、グループ別のデータバックアップや外部共有のニーズが高いため、P2とする。

**独立したテスト**: グループタブを選択し、CSVエクスポート機能を実行して、そのグループのみのデータがダウンロードされることを検証できる。

**受け入れシナリオ**:

1. **前提** GROUP 1に10名が登録済み, **操作** GROUP 1タブを選択して「CSV出力」ボタンを押下, **結果** GROUP 1の所属・名前・段級位を含む10名分のCSVファイルがダウンロードされる
2. **前提** GROUP 1に11名（ダミーユーザー含む）が登録済み, **操作** GROUP 1タブを選択して「CSV出力」ボタンを押下, **結果** GROUP 1のダミーユーザーを除く10名分のCSVファイルがダウンロードされる（ダミーユーザーは出力されない）
3. **前提** GROUP 1が空（0名）, **操作** GROUP 1タブを選択して「CSV出力」ボタンを押下, **結果** 「参加者が登録されていません」というメッセージが表示され、CSVファイルはダウンロードされない
4. **前提** GROUP 1に10名、GROUP 2に5名が登録済み, **操作** GROUP 2タブを選択して「CSV出力」ボタンを押下, **結果** GROUP 2の5名分のみのCSVファイルがダウンロードされる（GROUP 1のデータは含まれない）

---

### ユーザーストーリー 4 - グループ内参加者の個別編集・削除 (優先度: P2)

大会主催者が、グループタブから対象グループを選択し、登録済みの参加者の情報（所属・名前・段級位）を個別に編集・削除できる。編集後はそのグループ内で再度段級位順にソートされ、削除後にグループ内が奇数になった場合はダミーユーザーが追加される。

**なぜこの優先度か**: 参加者情報の誤入力修正や当日キャンセル対応に必要だが、初期MVPには必須ではないため、P2とする。

**独立したテスト**: グループタブを選択し、参加者一覧から特定の参加者を編集・削除して、そのグループ内でリストが正しく更新されることを検証できる。

**受け入れシナリオ**:

1. **前提** GROUP 1に5名が登録済み, **操作** GROUP 1タブで「山田太郎」の段級位を「3段」から「5段」に編集して保存, **結果** GROUP 1の参加者一覧が段級位順に再ソートされ、「山田太郎（5段）」が上位に移動する
2. **前提** GROUP 1に4名（偶数）が登録済み, **操作** GROUP 1タブで「山田太郎」を削除, **結果** GROUP 1の参加者一覧が3名（奇数）になり、ダミーユーザーが自動追加される
3. **前提** GROUP 1に5名（ダミーユーザー含む、奇数扱い）が登録済み, **操作** GROUP 1タブで実参加者1名を削除, **結果** GROUP 1の実参加者が3名（奇数）になり、ダミーユーザーは維持される
4. **前提** GROUP 1に10名、GROUP 2に5名が登録済み, **操作** GROUP 1タブで「山田太郎」を削除, **結果** GROUP 1の参加者一覧が9名になり、GROUP 2のデータには影響なし

---

### エッジケース

- **グループ内の参加人数が0名のとき**: そのグループの「参加者登録」ボタンは無効化され、対戦表には何も表示されない
- **グループ内の参加人数が1名のとき**: そのグループ内にダミーユーザーが1名追加され、合計2名（偶数）になる
- **グループが1つも作成されていないとき**: デフォルトでGROUP 1が自動作成され、タブに表示される
- **CSV取込で重複した名前が同一グループ内に含まれるとき**: 重複チェックは行わず、そのまま登録する（同姓同名の可能性を考慮）
- **異なるグループに同じ名前の参加者が存在するとき**: 問題なく登録できる（グループ間は独立）
- **段級位が同じ参加者が同一グループ内に複数いるとき**: 登録順で並び替える
- **所属が未入力のとき**: 所属は任意項目であり、空欄のまま登録可能
- **CSVファイルの文字エンコーディングがShift-JISのとき**: UTF-8とShift-JISの両方に対応する（Excel for Windowsとの互換性のため）
- **CSVファイルがグループの上限32名を超えるとき**: 「グループの参加人数上限は32名です」というエラーメッセージを表示し、取込を中止する
- **全グループ合計で256名（8グループ×32名）を超えるとき**: 技術的には可能だが、推奨されない規模として警告メッセージを表示する

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムは、最大8つのグループ（GROUP 1～GROUP 8）を作成・管理できる機能を提供しなければならない（MUST）
- **FR-002**: システムは、グループタブでグループを切り替えて表示できる機能を提供しなければならない（MUST）
- **FR-003**: システムは、選択されたグループ内で大会主催者が所属（任意）・名前（必須）・段級位（必須）を入力フォームから入力できる機能を提供しなければならない（MUST）
- **FR-004**: システムは、「参加者登録」ボタン押下時に、入力された参加者を選択中のグループ内で段級位の高い順にソートして追加しなければならない（MUST）
- **FR-005**: システムは、グループ内の参加人数が奇数の場合、自動的にダミーユーザー（名前: "ダミーユーザー（不戦勝）"、段級位: なし）をそのグループの参加者一覧の末尾に追加しなければならない（MUST）
- **FR-006**: システムは、1グループあたりの参加人数上限を32名とし、上限超過時はエラーメッセージを表示して登録を中止しなければならない（MUST）
- **FR-007**: システムは、選択中のグループに対して「CSV取込」ボタンから所属・名前・段級位を含むCSVファイルをアップロードし、一括で参加者を登録できる機能を提供しなければならない（MUST）
- **FR-008**: システムは、CSV取込時に名前または段級位が欠落している行がある場合、エラーメッセージを表示し、登録を中止しなければならない（MUST）
- **FR-009**: システムは、CSV取込時に段級位の形式が不正な行がある場合（例: "abc段"）、行番号を含むエラーメッセージを表示し、登録を中止しなければならない（MUST）
- **FR-010**: システムは、CSV取込時に既存参加者数と取込予定数の合計がグループ上限32名を超える場合、エラーメッセージを表示し、登録を中止しなければならない（MUST）
- **FR-011**: システムは、選択中のグループに対して「CSV出力」ボタン押下時に、そのグループの参加者一覧（ダミーユーザーを除く）をCSV形式でダウンロードできる機能を提供しなければならない（MUST）
- **FR-012**: システムは、CSVファイルの文字エンコーディングとしてUTF-8とShift-JISの両方に対応しなければならない（MUST）
- **FR-013**: システムは、参加者登録時に名前または段級位が未入力の場合、エラーメッセージを表示し、登録を中止しなければならない（MUST）
- **FR-014**: システムは、選択中のグループ内で登録済み参加者の所属・名前・段級位を個別に編集できる機能を提供すべきである（SHOULD）
- **FR-015**: システムは、選択中のグループ内で登録済み参加者を個別に削除できる機能を提供すべきである（SHOULD）
- **FR-016**: システムは、参加者の編集・削除後に選択中のグループ内で自動的に段級位順の再ソートとダミーユーザーの追加・削除を実行すべきである（SHOULD）
- **FR-017**: システムは、段級位が同じ参加者が同一グループ内に複数いる場合、登録順で並び替えなければならない（MUST）

### 主要なエンティティ *(機能がデータを含む場合に記載)*

> **注意**: このプロジェクトではバックエンドにDDDを採用しています。
> エンティティは `domain/model` 層に配置し、ビジネスロジックを含めます。

- **Group（グループ）**: トーナメント内のグループを表すエンティティ。主要な属性は以下の通り:
  - `groupId`: UUID（システム内部の一意識別子）
  - `tournamentId`: UUID（所属するトーナメントのID）
  - `groupNumber`: Integer（グループ番号、1～8）
  - `displayName`: String（表示名、例: "GROUP 1"）
  - 不変条件: groupNumberは1～8の範囲
  - ビジネスルール: 1グループあたりの参加者上限は32名（システム定数）

- **Participant（参加者）**: グループ内の参加者を表すエンティティ。主要な属性は以下の通り:
  - `participantId`: UUID（システム内部の一意識別子）
  - `groupId`: UUID（所属するグループのID）
  - `affiliation`: String（所属、任意）
  - `name`: String（名前、必須）
  - `rank`: Rank値オブジェクト（段級位、必須）
  - `isDummy`: Boolean（ダミーユーザーかどうか）
  - `registrationOrder`: Integer（登録順序、同段級位時のソートに使用）
  - 不変条件: nameとrankは必須、isDummyがtrueの場合はダミーユーザー専用の処理を行う、groupIdは必須

- **Rank（段級位）**: 段級位を表す値オブジェクト。主要な属性は以下の通り:
  - `level`: Integer（段級位のレベル、例: 初段=1、2段=2、9段=9、1級=-1、2級=-2、20級=-20）
  - `displayName`: String（表示名、例: "3段"、"2級"）
  - 不変条件: levelは1～9（段位：初段～9段）または-1～-20（級位：1級～20級）、displayNameはlevelから自動生成される
  - ビジネスロジック: 段級位の比較（level値で比較）、文字列からのパース処理

- **GroupParticipantList（グループ別参加者一覧）**: グループ内の参加者のコレクションを管理する集約ルート。主要な振る舞いは以下の通り:
  - `addParticipant(groupId, Participant)`: 指定グループに参加者を追加し、グループ内で段級位順にソート
  - `removeParticipant(groupId, participantId)`: 指定グループから参加者を削除
  - `updateParticipant(groupId, participantId, Participant)`: 指定グループの参加者を更新し、グループ内で再ソート
  - `ensureEvenCount(groupId)`: 指定グループの参加人数が奇数の場合、ダミーユーザーを追加
  - `getSortedParticipants(groupId)`: 指定グループの段級位順にソートされた参加者リストを取得（ダミーユーザーは末尾）
  - `exportToCsv(groupId)`: 指定グループのダミーユーザーを除く参加者をCSV形式で出力
  - `validateGroupCapacity(groupId, additionalCount)`: 指定グループに参加者を追加可能かチェック（32名上限）
  - 不変条件: 各グループの参加人数は常に偶数（奇数の場合は自動的にダミーユーザーを追加）、1グループあたりの参加人数上限は32名

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: 大会主催者が、1グループあたり32名の参加者をCSVファイルから一括登録する操作を1分以内に完了できる
- **SC-002**: 参加者登録後、対戦表に参加者が反映されるまでの応答時間が3秒以内である（全8グループ、最大256名規模を想定）
- **SC-003**: グループ切り替え操作（タブクリック）の応答時間が1秒以内である
- **SC-004**: CSVファイルの文字エンコーディング（UTF-8/Shift-JIS）を自動判定し、99%以上の精度で正しく取り込める
- **SC-005**: 参加者の登録・編集・削除操作において、グループ内での段級位順のソートとダミーユーザーの自動追加が100%正確に動作する
- **SC-006**: CSV取込時のエラー検出（必須項目の欠落、段級位形式の不正、グループ上限超過）が100%の精度で実行され、適切なエラーメッセージが表示される